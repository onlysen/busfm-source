function siteNotice(){getCookie("sitenotice"+$("#noticeid").val())!="true"&&($("#notice").show().animate({opacity:1},2e3),setTimeout(function(){$("#notice").animate({opacity:0},2e3,function(){$(this).hide()})},3e4))}function setCookie(a,b,c){var d=new Date;d.setDate(d.getDate()+c),document.cookie=a+"="+escape(b)+(c==null?"":";expires="+d.toUTCString())}function getCookie(a){var b=document.cookie.match(new RegExp("(^|;\\s*)"+a+"=([^;]*)(;|$)"));if(b!=null)return unescape(decodeURI(b[2]));return""}function popAlert(a,b){var c=b||1,d=$("#msgs"),e=c==1?3e3:15e3;d.html(a).stop(!0,!0).css("margin-left",function(){return-($(this).width()/2)}).animate({opacity:1},1e3).delay(e).animate({opacity:0},2e3),c==1?d.removeClass("errdiv").addClass("alertdiv"):d.removeClass("alertdiv").addClass("errdiv")}function checkLastTime(){var a=getCookie("join_time");if(a=="")return NaN;var b=Math.round((new Date).getTime()/1e3);b=Math.round((b-a)/60);var c=b%60;b=Math.round(b/60);return b+"小时"+c+"分"}function getPromoteDiary(){var c=$("#publicdiary"),i=Number(c.data("i")),e=eval(c.data().diary);++i>=e.length?$.get("/ajax/pblog",function(d){var s=eval(d);s.length>0&&c.data({diary:d,i:0}).find(".pbmain").html(decodeURIComponent(s[0][1])).nextAll(".pbauthor").html(s[0][3])}):c.data("i",i).find(".pbmain").html(decodeURIComponent(e[i][1])).nextAll(".pbauthor").html(e[i][3])}function ifvali(a,b,c){var d=$("#lblmsg"),e=b.parent("li").index(),f=$("p",d).eq(e);c=c||"",a?(b.removeClass("onerror"),b.data({otxt:b.val()})):(vali=!1,d.show(),b.addClass("onerror")),f.text(c)}function setProfile(a){var b=$("#u-info .u-info-regtime"),c=b.text();b.is(".havetime")||(c=a||(new Date(Number(getCookie("join_time"))*1e3)).toLocaleString().replace(/^(\S+)\s(\d+):(\d+):(\d+)$/,"$1$2时$3分$4秒")),$("#u-info").find(".u-info-name").text(getCookie("member_nickname")).end().find(".u-info-lasttime").text(checkLastTime()).end().find(".u-info-regtime").text(c)}function logout(){$.get("/ajax/member?action=logout&t="+(new Date).getMilliseconds(),function(){$("#txtemail").val(""),$("#txtpwd").val(""),$("#u-login").slideDown(1e3),$("#u-info").slideUp(1e3),$("#box-main").fadeOut(1e3)})}function loginmsg(a){$("#loginmsg").css({opacity:1}).text(a).animate({opacity:0},5e3,!1)}function reg(){popAlert("提交中...");if(!em_o||!nn_o||!an_o)setTimeout(function(){reg()},333);else if(vali){var a=$("#form2");if(a.data("xmlhttp")!=undefined){popAlert("请求正在处理，请勿重复提交",2);return}var b=encodeURI(a.attr("action")+"&t="+(new Date).getMilliseconds()),c=$.post(b,a.serialize(),function(b){a.removeData("xmlhttp");var c=b.split("|");c[0]=="0"?popAlert(c[1],2):(popAlert(c[1]),getaccount(!0))});a.data("xmlhttp",c)}else vali=!0}function getpwd(){$.get(encodeURI("/ajax/member?action=forget_ok&member_mail="+$("#txtemail").val()+"&t="+(new Date).getMilliseconds()),function(a){var b=a.split("|");b[0]=="0"?popAlert(b[1],2):popAlert(b[1])})}function goLogin(){$("#u-login").slideDown(1e3),$("#u-reg").slideUp(1e3)}function getaccount(a){a?($("#u-login").slideDown(1e3),$("#u-reg").slideUp(1e3)):($("#u-login").slideUp(1e3),$("#u-reg").slideDown(1e3))}function checkSideBar(){var a=$("#sidebar");a.css("right")!="0px"&&a.animate({right:0},1e3,function(){$("#sidebar-switch").css({"background-position":"4px -44px"})})}function songMarquee(){$("#SongInfo ul").animate({"margin-top":-28},1e3,function(){$(this).css({"margin-top":0}).find("li:first").appendTo(this)})}var simar,diarys=[],curindex=0,curpage=1,itflag=0,globleInterval;$(function(){function checktxtctr(a){if(a.val().length>200){a.val(a.val().substring(0,200));return!1}return!0}function setDiaryStatus(a){var b=a>-1?"icopublic":"icoprivate",c=a>-1?"公开":"私人";$("#diarystatus").removeClass("icopublic icoprivate").addClass(b).attr("title",c)}function setDiary(a,b,c,d){$("#diarylist .diarybody").fadeOut(500,function(){$(this).html(decodeURIComponent(b)).removeClass("center").data({id:a})}).fadeIn(500),$("#diarylist .diarytime").html(c),setDiaryStatus(d)}function getDiaryList(pageindex){var page=pageindex||1,od=$(".diarybody"),ot=od.html();od.html("<img src='image/loading.gif' alt='' />").addClass("center"),$.get("/ajax/micblog",{action:"list",t:(new Date).getMilliseconds()},function(j){f=j.split("|");if(f[0]=="0")popAlert(f[1]),od.html(ot).removeClass("center");else try{curpage++;var d=eval(j.replace(/\s/g," "));diarys=diarys.concat(d),setDiary(d[0][0],d[0][1],d[0][2],d[0][3])}catch(err){popAlert(err.message)}})}function setbox(a,b){b?(diarys.length==0&&getDiaryList(),a.fadeIn(1e3)):a.fadeOut(1e3)}getCookie("member_id")!=""&&($("#u-login").hide(),$("#u-info").show(),setProfile()),$("body").ajaxError(function(a,b,c){popAlert("服务器错误"+c.url,2),$(".sidewidget").hide()}),$("#sidebar-switch").click(function(){var a=$(this),b=$("#sidebar");b.css("right")=="0px"?b.animate({right:-190},1e3,function(){a.css({"background-position":"-14px -44px"})}):b.animate({right:0},1e3,function(){a.css({"background-position":"4px -44px"})})}),$("#fav").click(function(a){a.stopPropagation();var b=getCookie("member_id");if(b=="")popAlert("您还未登录，无法使用收藏功能<a href='#' id='notlogin'>没有账号</a>?",2);else{var c=$(this);if(c.data("xmlhttp")!=undefined)return;var d=$(this).data("cursongid"),e=$("span",this),f=encodeURI("/ajax/sc?id="+d+"&t="+(new Date).getMilliseconds());isie9&&window.external.msIsSiteMode()&&setFavBtnState(!$("#fav span").is(".star"));var g=$.get(f,function(a){c.removeData("xmlhttp");var b=a.split("|");b[0]=="0"?popAlert(b[1],2):(e.toggleClass("star"),popAlert(b[1]))});c.data("xmlhttp",g);return!1}}),$("#channel_ico").click(function(){var a=$("#channel-list");checkSideBar(),a.css("opacity")==0&&(a.show().animate({opacity:1,top:"30%"},1e3),$("#user-panel").animate({opacity:0,top:"80%"},1e3,!1,function(){$(this).hide()}));return!1}),$("#notlogin").live("click",function(){$("#user_ico").trigger("click");return!1}),$("#user_ico").click(function(){var a=$("#user-panel");checkSideBar(),a.css("opacity")==0&&($("#channel-list").animate({opacity:0,top:"10%"},1e3,function(){$(this).hide()}),a.show().animate({opacity:1,top:"30%"},1e3,!1));return!1}),simar=setInterval(songMarquee,8e3),$("#SongInfo ul").hover(function(){clearInterval(simar)},function(){simar=setInterval(songMarquee,8e3)}),$("#ieupgrade").hover(function(){$(this).addClass("iehover")},function(){$(this).removeClass("iehover")}).click(function(){window.open("choice.html"),$(this).slideUp(600)}).find(".ieclose").click(function(a){$(this).parent("div").slideUp(600),a.stopPropagation()}),$("#diarybox").click(function(){var a=$("#box-main");setbox(a,a.is(":hidden"))}),$("#boxclose").click(function(){setbox($("#box-main"),!1)}),$("#subdiary").click(function(){var a=$("#txtdiary"),b=encodeURIComponent(a.val()).replace(/\n+/g,"<br />"),c=$("#isprivate").is(":checked")?-1:0;$.get("/ajax/micblog",{action:"add_ok",isprivate:c,content:b,t:(new Date).getMilliseconds()},function(d){f=d.split("|"),f[0]=="0"?popAlert(f[1],2):(popAlert("添加日记成功"),$("#txtctr").text("200"),diarys.unshift([f[2],b,f[3],c]),a.val(""),curindex=0,curpage=1,setDiary(diarys[curindex][0],diarys[curindex][1],diarys[curindex][2],diarys[curindex][3]))})}),$("#diarylist .leftarr").click(function(){--curindex<0?(popAlert("喔唷，没有了"),curindex=0):setDiary(diarys[curindex][0],diarys[curindex][1],diarys[curindex][2],diarys[curindex][3])}),$("#diarylist .rightarr").click(function(){diarys.length>++curindex?setDiary(diarys[curindex][0],diarys[curindex][1],diarys[curindex][2],diarys[curindex][3]):getDiaryList(curpage)}),$("#diarydel").click(function(){if(diarys.length!=0){var a=$(this);if(a.data("xmlhttp")!=undefined)return;var b=$("#diarylist .diarybody").data("id"),c=$.get("/ajax/micblog",{t:(new Date).getMilliseconds(),action:"del",id:b},function(b){a.removeData("xmlhttp");var c=b.split("|");c[0]=="0"?popAlert(c[1],2):(diarys.splice(curindex,1),popAlert(c[1]),diarys.length==0?$("#diarylist").find(".diarybody").html("你随便的说，<br />我却认真地难过。"):setDiary(diarys[curindex][0],diarys[curindex][1],diarys[curindex][2],diarys[curindex][3]))});a.data("xmlhttp",c)}}),$("#diarystatus").click(function(){var a=$("#diarystatus");if(a.data("xmlhttp")==undefined){var b=a.is(".icopublic")?-1:0,c=$("#diarylist .diarybody").data("id"),d=$.get("/ajax/micblog",{t:(new Date).getMilliseconds(),action:"s",id:c,isprivate:b},function(c){a.removeData("xmlhttp");var d=c.split("|");d[0]==0?popAlert(d[1],2):(setDiaryStatus(b),popAlert(d[1]))});a.data("xmlhttp",d)}});var box=$("#box-main");$("#b-head").mousedown(function(a){var b=$(this),c=box.position();b.data({ox:a.pageX,oy:a.pageY,onmove:!0,left:c.left,top:c.top})}),$("*").mousemove(function(a){var b=$("#b-head");if(b.data("onmove")){var c=a.pageX-b.data("ox"),d=a.pageY-b.data("oy"),e=b.data("left")+c,f=b.data("top")+d;e<0?e=0:e=Math.min(e,document.body.clientWidth-box.width()-5),f<0?f=6:f=Math.min(f,document.body.clientHeight-box.height()-20),box.css({left:Math.max(e,0),top:Math.max(f,6)}),this.onselectstart=function(){event.returnValue=!1;return!1}}else this.onselectstart=function(){event.returnValue=!0;return!0}}),$("*").mouseup(function(a){$("#b-head").data("onmove",!1)});var tc;$("#txtdiary").focus(function(){tc=setInterval(function(){var a=$("#txtdiary");checktxtctr(a),$("#txtctr").text(200-a.val().length)},200)}).blur(function(){clearInterval(tc)}).keydown(function(){return checktxtctr($(this))}).val("").click(function(){$(this).blur().focus()}),$("#publicdiary").data({diary:[],i:0}),getPromoteDiary(),globleInterval=setInterval(function(){itflag=itflag++%10,itflag%3==0&&getPromoteDiary(),setProfile()},6e4),$("#notice n-body").html()!=""&&siteNotice(),$("#notice .n-close").click(function(){$("#notice").animate({opacity:0},2e3,function(){$(this).hide(),setCookie("sitenotice"+$("#noticeid").val(),"true",30)})}),$(".statusbar,#coverimg").click(function(){$("#jplayer_pause").is(":hidden")?$("#jplayer_play").trigger("click"):$("#jplayer_pause").trigger("click")}),$("#recom").click(function(a){a.stopPropagation();if($("#hidchannel").val()=="100")popAlert("特殊频道不支持分享",2);else{var b=$(this);if(b.data("xmlhttp")!=undefined)return;var c="/ajax/public?action=url&id="+$("#fav").data("cursongid")+"&t="+(new Date).getMilliseconds(),d=$.get(encodeURI(c),function(a){b.removeData("xmlhttp"),Number(a)==0?popAlert("操作失败，请稍候再试",2):$("#clipbord").stop(!0,!0).css({"margin-left":function(){return-($(this).width()/2)},opacity:1}).animate({bottom:80},200).find(".mp3url").val(a).select()});b.data("xmlhttp",d);return!1}}),$("#clipbord .n-close").click(function(){$("#clipbord").animate({bottom:-30},200,function(){$(this).css("opacity",0).find(".mp3url").blur()})}),$(".mp3url").keyup(function(a){a.which==27&&$("#clipbord .n-close").trigger("click")}),$("#clipbord .snsicon").click(function(){var a=$(this),b=encodeURIComponent(myPlayList[playItem][1]+" - "+myPlayList[playItem][3]),c=encodeURIComponent($(".mp3url").val()),d=$("#coverimg img").attr("src");d=encodeURIComponent(d=="/image/default.gif"?"":d);var e="";switch(a.attr("name")){case"xl":e="http://v.t.sina.com.cn/share/share.php?title="+b+"&url="+c+"&appkey=4071314818&pic="+d+"&ralateUid=";break;case"rr":e="http://share.renren.com/share/buttonshare.do?link="+c+"&title="+b;break;case"db":e="http://www.douban.com/recommend/?url="+c+"&title="+b;break;case"ff":e="http://fanfou.com/sharer?u="+c+"&t="+b+"&d=&s=";break;case"tx":e="http://v.t.qq.com/share/share.php?title="+b+"&url="+c+"&site=&pic="+d+"&appkey=a3f50d5a65d949a1997f5f5dce42fb67";break;case"bz":e="http://www.google.com/buzz/post?url="+c+"&message="+b+"&imageurl="+d;break;case"tt":e="http://twitter.com/home?status="+c;break;case"fb":e="http://www.facebook.com/share.php?u="+c+"&t="+b}window.open(e,"favit","width=720,height=500,left=50,top=50,toolbar=no,menubar=no,location=no,scrollbars=yes,status=yes,resizable=yes")}),$("#historys img").live("mousemove",function(a){var b=$("#his-tips"),c=$(this).css({opacity:1}),d="曲目: "+c.data("title")+"<br/>歌手: "+c.data("artist")+"<br/>专辑: "+c.data("album");b.find(".ht-cont").html(d).end().css({top:function(){return a.clientY-$(this).height()-20},left:function(){return a.clientX-$(this).width()/2}}).show()}).live("mouseout",function(){$("#his-tips").hide(),$(this).css({opacity:.6})})});var vali=!0,em_p=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,em_o=!1,nn_o=!1,an_o=!0;$("#txtemail_r").blur(function(){var a=$(this);a.val()==a.data("otxt")?ifvali(!0,a):a.val()==""||!em_p.test(a.val())?ifvali(!1,a,"邮件地址不正确"):(em_o=!1,$.get(encodeURI("/ajax/member?action=validate_mail&mail="+a.val()+"&t="+(new Date).getMilliseconds()),function(b){em_o=!0;var c=b.split("|");c[0]=="0"?ifvali(!1,a,c[1]):ifvali(!0,a)}))}),$("#txtpwd_r").blur(function(){var a=$(this);a.val()==a.data("otxt")?ifvali(!0,a):a.val()==""||!/^[0-9a-zA-Z]{6,20}$/.test(a.val())?ifvali(!1,a,"密码6-20位数字和字母"):ifvali(!0,a)}),$("#txtpwd_r2").blur(function(){var a=$(this);a.val()==a.data("otxt")?ifvali(!0,a):a.val()!=$("#txtpwd_r").val()?ifvali(!1,a,"密码输入不一致"):ifvali(!0,a)}),$("#txtnickname").blur(function(){var a=$(this);a.val()==a.data("otxt")?ifvali(!0,a):a.val()==""?ifvali(!1,a,"请输入您的昵称"):(nn_o=!1,$.get(encodeURI("/ajax/member?action=validate_nickname&name="+a.val()+"&t="+(new Date).getMilliseconds()),function(b){nn_o=!0;var c=b.split("|");c[0]=="0"?ifvali(!1,a,c[1]):ifvali(!0,a)}))}),$("#form2").bind("submit",function(a){$(".txtreg").blur(),reg(),a.preventDefault()}),$("#form1").bind("submit",function(a){a.preventDefault();var b=$("#txtemail").val();if(b==""||!em_p.test(b)||$("#txtpwd").val()=="")loginmsg("登录信息无效");else{var c=encodeURI($(this).attr("action")+"&t="+(new Date).getMilliseconds());$.post(c,$(this).serialize(),function(a){var b=a.split("|");b[0]=="0"?loginmsg(b[1]):($("#u-login").slideUp(1e3),$("#u-info").slideDown(1e3),setProfile())})}})